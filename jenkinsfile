pipeline{
    parameters{
        choice(name:'terraformactions', choices :['apply','destroy'], description:'Choose your terraform action')
    }

    environment{
        Sceret_key=credentials('Sceret_keycredentials')
        access_key=credentials('access_key')
    }
    agent any

    stages{
        stage('checkout'){
            steps{

                git branch : 'terraform' , url: 'https://github.com/Suhelk739/Devops.git'

            }

        }

        stage('Plan'){
            steps{
                sh "pwd && terraform init"
                sh "pwd && terraform plan -out tfplan"
                sh "pwd && terraform show -no-color >> tfplan.txt"
            }

        }
        stage('approve'){
            def plan = readfile 'tfplan.txt'
            input message: "Do you want to approve this"
            parameters(text(name:'plan', description:'please approve', defaultValue:plan) )

        }

        stage('approve or destroy'){
            when{
                expression{
                    return params.terraformactions == 'apply' || params.terraformactions == 'destroy'                }
            }
            steps{
                if(params.terraformactions == 'apply'){
                    sh "pwd && cd Project-1 && terraform plan -input=false tfplan"
                }
                else if (params.terraformactions == 'destroy'){
                    sh "pwd && cd Project-1 && terraform destroy -auto-approve"
                }
            }

        }
    }
}
